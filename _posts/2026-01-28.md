from appium.webdriver.common.appiumby import AppiumBy
from selenium.common.exceptions import NoSuchElementException
import time

def create_cards_until_10(driver):
    CARD_ID = "com.example.app:id/card_item"
    ADD_BTN_ID = "com.example.app:id/btn_add"
    INPUT_ID = "com.example.app:id/input_name"
    SAVE_BTN_ID = "com.example.app:id/btn_save"
    DUPLICATE_TEXT = "중복입니다"

    cards = driver.find_elements(AppiumBy.ID, CARD_ID)
    need_count = 10 - len(cards)

    if need_count <= 0:
        return

    name_index = 1
    created = 0

    while created < need_count:
        driver.find_element(AppiumBy.ID, ADD_BTN_ID).click()
        time.sleep(0.5)

        name = f"test_{name_index}"
        input_el = driver.find_element(AppiumBy.ID, INPUT_ID)
        input_el.clear()
        input_el.send_keys(name)

        driver.find_element(AppiumBy.ID, SAVE_BTN_ID).click()
        time.sleep(0.5)

        try:
            driver.find_element(
                AppiumBy.ANDROID_UIAUTOMATOR,
                f'new UiSelector().text("{DUPLICATE_TEXT}")'
            )
            name_index += 1
            driver.back()   # 생성 화면 유지 or 다시 입력 가능 구조면 제거
            continue
        except NoSuchElementException:
            created += 1
            name_index += 1
            time.sleep(1)


from appium.webdriver.common.appiumby import AppiumBy

def find_all_elements_by_scroll(driver, target_id):
    collected = {}
    prev_count = -1

    while True:
        elements = driver.find_elements(AppiumBy.ID, target_id)

        for el in elements:
            key = el.id  # Appium 내부 element id (중복 방지)
            collected[key] = el

        if len(collected) == prev_count:
            break  # 더 이상 새 요소 없음 → 끝
        prev_count = len(collected)

        # 스크롤 (한 화면씩)
        driver.find_element(
            AppiumBy.ANDROID_UIAUTOMATOR,
            'new UiScrollable(new UiSelector().scrollable(true))'
            '.scrollForward()'
        )

    return list(collected.values())







            
from appium.webdriver.common.appiumby import AppiumBy

def count_all_cards(driver):
    CARD_ID = "com.example.app:id/card_root"

    collected = {}
    prev_count = -1

    while True:
        cards = driver.find_elements(AppiumBy.ID, CARD_ID)

        for card in cards:
            collected[card.id] = card

        if len(collected) == prev_count:
            break  # 더 이상 새 카드 없음 → 스크롤 끝

        prev_count = len(collected)

        # 한 화면씩 스크롤
        driver.find_element(
            AppiumBy.ANDROID_UIAUTOMATOR,
            'new UiScrollable(new UiSelector().scrollable(true))'
            '.scrollForward()'
        )

    routine = len(collected)
    return routine





from appium.webdriver.common.appiumby import AppiumBy

def count_all_cards(driver):
    RUN_CARD_ID = "com.example.app:id/card_run"
    TEXT_CARD_ID = "com.example.app:id/card_text"

    collected = set()
    prev_count = -1

    while True:
        # 1️⃣ Run 버튼 카드 수집
        run_cards = driver.find_elements(AppiumBy.ID, RUN_CARD_ID)
        for card in run_cards:
            collected.add(card.id)

        # 2️⃣ 메인 텍스트 카드 수집
        text_cards = driver.find_elements(AppiumBy.ID, TEXT_CARD_ID)
        for card in text_cards:
            collected.add(card.id)

        # 종료 조건
        if len(collected) == prev_count:
            break
        prev_count = len(collected)

        # 3️⃣ 다음 화면으로 스크롤
        driver.find_element(
            AppiumBy.ANDROID_UIAUTOMATOR,
            'new UiScrollable(new UiSelector().scrollable(true))'
            '.scrollForward()'
        )

    routine = len(collected)
    return routine


    
